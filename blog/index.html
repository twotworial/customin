<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Blog & Artikel | Customin.co</title>
  <meta name="description" content="Artikel seputar furniture custom, tips perawatan, dan behind-the-scenes produksi dari Customin.co.">

  <link rel="icon" href="/OG/favicon-customin-furniture-custom.ico" />

  <!-- CSP: Iconify tetap dari CDN, tapi tanpa auto-fetch (tidak perlu connect ke api.iconify/uni/simple) -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://code.iconify.design https://cloud.umami.is https://*.disqus.com;
    connect-src 'self' https://api.iconify.design https://api.simplesvg.com https://api.unisvg.com https://cloud.umami.is https://api-gateway.umami.dev https://*.umami.is https://*.umami.dev;
    style-src 'self' 'unsafe-inline';
    font-src 'self' data:;
    img-src 'self' https: data:;
    worker-src 'self';
    frame-src 'self' https://*.disqus.com;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    upgrade-insecure-requests
  ">
  <!-- Inter Variable lokal (seperti index.html) -->
  <style>
    :root{font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    @supports (font-variation-settings: normal){
      :root{font-family:"InterVariable",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;font-optical-sizing:auto}
    }
    @font-face{
      font-family:InterVariable; font-style:normal; font-weight:100 900; font-display:swap;
      src:url("/assets/fonts/InterVariable.woff2") format("woff2");
    }
  </style>

  <!-- Preload ringan -->
  <link rel="preload" href="/blog/blog.css" as="style">
  <link rel="preload" href="/assets/cart.css" as="style">
  <link rel="preload" href="/blog/posts.json" as="fetch" crossorigin="anonymous">

  <!-- CSS utama + non-blocking cart.css -->
  <link rel="stylesheet" href="/blog/blog.css">
  <link rel="stylesheet" href="/assets/cart.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="/assets/cart.css"></noscript>

  <!-- Iconify (CDN) + matikan auto-fetch + koleksi lokal -->
  <script src="https://code.iconify.design/3/3.1.1/iconify.min.js" defer></script>
  <script defer>
    window.Iconify && Iconify.setConfig({ autoFetch:false, fetch:false });
  </script>
  <script src="/assets/icons/register-icons.js" defer></script>

  <!-- Umami -->
  <script defer src="https://cloud.umami.is/script.js" data-website-id="60976a45-9ae8-40bf-a8bc-99c152ba5288"></script>
</head>
<body>
  <div class="main-wrapper">
    <div class="bio-card">
      <header class="page-head">
        <nav class="crumbs" aria-label="Breadcrumb">
          <ol>
            <li><a href="/">Home</a></li>
            <li class="sep" aria-hidden="true">›</li>
            <li aria-current="page">Blog</li>
          </ol>
        </nav>
        <h1 class="page-title">Blog & Artikel</h1>
      </header>

      <main class="card-content">
        <!-- Search -->
        <section class="filters">
          <div class="search-wrap">
            <span class="iconify" data-icon="mdi:magnify"></span>
            <input id="q" type="search" placeholder="Cari artikel… (mis. jati, perawatan)" autocomplete="off" />
          </div>
        </section>

        <!-- List -->
        <section id="postsList" class="posts-list" aria-live="polite"></section>

        <!-- Pagination -->
        <nav id="pager" class="pagination" aria-label="Pagination"></nav>

        <!-- Template -->
        <template id="postCardTmpl">
          <article class="post-card">
            <a class="post-cover" href="#"><img src="" alt=""></a>
            <div class="post-content">
              <h2 class="post-title"><a href="#"></a></h2>
              <div class="post-meta">
                <time class="post-date"></time>
                <span class="dot"></span>
                <a class="post-comments" href="#" data-disqus-identifier="">
                  <span class="iconify" data-icon="mdi:message-outline"></span>
                  <span class="count">0</span>
                </a>
                <span class="dot"></span>
                <a class="pd-chip" href="#">
                  <span class="iconify" data-icon="mdi:label-outline"></span>
                  <span class="chip-text"></span>
                </a>
              </div>
              <p class="post-excerpt"></p>
            </div>
          </article>
        </template>
      </main>

      <!-- NAV (Home | Menu | Cart) -->
      <nav class="in-card-nav" aria-label="Navigasi utama">
        <div class="nav-content">
          <a href="/" class="nav-item" title="Home" aria-label="Home"><span class="iconify" data-icon="mdi:home-outline"></span></a>
          <button type="button" class="menu-button" id="menuButton" aria-controls="popupMenu" aria-expanded="false" aria-label="Menu"><span class="iconify" data-icon="mdi:view-grid-outline"></span></button>
          <a href="/keranjang" class="nav-item js-cart-btn" title="Keranjang" aria-label="Keranjang">
            <span class="iconify" data-icon="mdi:cart-outline"></span>
            <span class="cart-badge" data-cart-count>0</span>
          </a>
        </div>
      </nav>
    </div>
  </div>

  <div class="popup-menu" id="popupMenu"></div>

  <!-- Cart + Menu -->
  <script src="/assets/cart.js" defer></script>
  <script>
  // Popup menu ringkas
  (()=>{const b=document.getElementById('menuButton'),p=document.getElementById('popupMenu');
    if(!b||!p) return;
    p.innerHTML=`<ul>
      <li><a href="/produk/"><span class="iconify" data-icon="mdi:view-grid-plus-outline"></span>Produk</a></li>
      <li><a href="/kategori/"><span class="iconify" data-icon="mdi:shape-outline"></span>Kategori</a></li>
      <li><a href="/tag/"><span class="iconify" data-icon="mdi:tag-outline"></span>Tag</a></li>
      <li><a href="/kontak.html"><span class="iconify" data-icon="mdi:phone-outline"></span>Kontak</a></li>
    </ul>`;
    b.addEventListener('click',e=>{e.stopPropagation();p.classList.toggle('show');b.setAttribute('aria-expanded',p.classList.contains('show'));});
    document.addEventListener('click',e=>{if(!p.contains(e.target)) p.classList.remove('show')});
  })();

  // ===== Blog: fetch + render + pagination + komentar count (ringan) =====
  (async ()=>{
    const list  = document.getElementById('postsList');
    const pager = document.getElementById('pager');
    const tmpl  = document.getElementById('postCardTmpl');
    const q     = document.getElementById('q');
    const PER_PAGE = 9;

    const urlPage = +new URL(location.href).searchParams.get('page') || 1;
    let curPage = urlPage;

    let posts = [];
    try{
      const res = await fetch('/blog/posts.json', {cache:'no-store'});
      posts = await res.json();
    }catch(e){ console.error('Gagal load posts.json', e); }

    posts = posts
      .filter(p => p && (p.title || p.slug))
      .sort((a,b)=> new Date(b.date) - new Date(a.date));

    function makeCard(p, idxGlobal){
      const n = tmpl.content.cloneNode(true);
      const url = p.url || `/blog/${p.slug}.html`;

      // cover
      const coverA = n.querySelector('.post-cover');
      const img = n.querySelector('img');
      coverA.href = url;
      img.src = p.cover || '/OG/Cover-Furniture-Custom-by-Customin.webp';
      img.alt = p.coverAlt || p.title || '';
      img.decoding = 'async';
      // LCP: hanya untuk kartu pertama pada halaman 1
      if (curPage===1 && idxGlobal===0) {
        img.loading = 'eager';
        img.setAttribute('fetchpriority','high');
      } else {
        img.loading = 'lazy';
      }

      // title
      const t = n.querySelector('.post-title a');
      t.textContent = p.title || '(Tanpa judul)';
      t.href = url;

      // meta
      n.querySelector('.post-date').textContent =
        p.date ? new Date(p.date).toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'}) : '';

      const cmt = n.querySelector('.post-comments');
      cmt.href = `${url}#disqus_thread`;
      cmt.setAttribute('data-disqus-identifier', p.id || p.slug || p.title || url);

      const chip = n.querySelector('.pd-chip');
      const tag  = p.category || 'Umum';
      chip.href = `/blog/?q=${encodeURIComponent(tag)}`;
      chip.querySelector('.chip-text').textContent = tag;

      n.querySelector('.post-excerpt').textContent = p.excerpt || '';
      return n;
    }

    function renderPage(){
      const keyword = (q.value||'').toLowerCase().trim();
      const filtered = !keyword ? posts :
        posts.filter(p => (p.title+p.excerpt+p.category).toLowerCase().includes(keyword));

      const totalPages = Math.max(1, Math.ceil(filtered.length / PER_PAGE));
      curPage = Math.min(Math.max(1, curPage), totalPages);

      const start = (curPage-1)*PER_PAGE;
      const slice = filtered.slice(start, start+PER_PAGE);

      list.innerHTML = '';
      slice.forEach((p,i)=> list.appendChild(makeCard(p, start+i)));

      // pagination
      pager.innerHTML = '';
      const mkBtn = (label, page, {active=false, disabled=false}={})=>{
        const a = document.createElement('a');
        a.className = 'page-btn' + (active?' active':'') + (disabled?' disabled':'');
        a.textContent = label;
        if(!disabled){
          a.href = `?page=${page}`; a.addEventListener('click', e=>{ e.preventDefault(); go(page); });
        }
        return a;
      };
      const go = (p)=>{ if(p===curPage) return; curPage=p; history.replaceState(null,'',`?page=${p}`); renderPage(); };
      pager.appendChild(mkBtn('Prev', curPage-1, {disabled:curPage<=1}));
      for(let i=1;i<=totalPages;i++){
        // ringkas jika halaman banyak
        if (i===1 || i===totalPages || Math.abs(i-curPage)<=1){
          pager.appendChild(mkBtn(String(i), i, {active:i===curPage}));
        } else if (Math.abs(i-curPage)===2){
          const s=document.createElement('span'); s.className='pg-ellipsis'; s.textContent='…'; pager.appendChild(s);
        }
      }
      pager.appendChild(mkBtn('Next', curPage+1, {disabled:curPage>=totalPages}));

      // muat Disqus count setelah render
      lazyLoadDisqus();
      // sinkronkan angka: tarik angka dari teks yang diisi Disqus
      syncCountsSoon();
    }

    q?.addEventListener('input', ()=>{ curPage=1; renderPage(); });

    // Disqus: lazy + sinkron angka
    let dsqLoaded = false, syncTimer;
    function lazyLoadDisqus(){
      if (dsqLoaded) return;
      const loader = ()=> {
        if (dsqLoaded) return;
        const s = document.createElement('script');
        s.id = 'dsq-count-scr';
        s.src = '//custominco.disqus.com/count.js';
        s.async = true;
        document.body.appendChild(s);
        dsqLoaded = true;
      };
      if ('requestIdleCallback' in window) requestIdleCallback(loader, {timeout:1500});
      else setTimeout(loader, 1200);
    }
    function syncCountsSoon(){
      clearTimeout(syncTimer);
      syncTimer = setTimeout(()=>{
        document.querySelectorAll('.post-comments').forEach(a=>{
          const text = a.textContent || '';
          const m = text.match(/\d+/);
          const num = m ? m[0] : '0';
          const span = a.querySelector('.count');
          if (span) span.textContent = num;
          // kosongkan teks selain ikon & angka agar rapi
          a.childNodes.forEach(n=>{
            if (n.nodeType===3) n.textContent='';
          });
        });
      }, 1400);
    }

    renderPage();
  })();
  </script>
</body>
</html>
