<script>
(() => {
  const KEY = 'customin_cart';
  const $badges = () => document.querySelectorAll('[data-cart-count]');

  const read = () => {
    try { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
    catch { return []; }
  };

  const write = (items) => {
    localStorage.setItem(KEY, JSON.stringify(items));
    const count = items.reduce((n, i) => n + (i.qty || 1), 0);

    // update angka + tampilkan badge
    $badges().forEach(b => b.textContent = count);
    document.body.classList.toggle('has-items', count > 0);

    // beri tahu listener lain (kalau ada)
    document.dispatchEvent(new CustomEvent('cart:update', { detail: { items, count } }));
  };

  const add = (item) => {
    const items = read();
    const i = items.findIndex(x => x.slug === item.slug);
    const inc = Math.max(1, item.qty | 0); // minimal 1

    if (i > -1) items[i].qty = (items[i].qty || 1) + inc;
    else items.push({ slug: item.slug, title: item.title, price: item.price, cover: item.cover, qty: inc });

    write(items);
  };

  const remove = (slug) => write(read().filter(i => i.slug !== slug));
  const clear  = () => write([]);

  // expose API (pastikan cuma satu yang aktif)
  window.Cart = { read, write, add, remove, clear };

  // set badge awal
  write(read());
})();
</script>
