<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Katalog Produk | Customin.co</title>
  <meta name="description" content="Katalog produk furniture custom: kursi, meja, lemari, rak, dan lainnya.">
  <link rel="icon" href="/OG/favicon-customin-furniture-custom.ico" />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://code.iconify.design/3/3.1.1/iconify.min.js" defer></script>

  <!-- Styles -->
  <link rel="stylesheet" href="/katalog.css" />
  <link rel="stylesheet" href="/assets/cart.css" />
</head>
<body>
  <div class="main-wrapper">
    <div class="bio-card">

      <!-- Header -->
      <header class="page-head">
        <nav class="crumbs" aria-label="Breadcrumb">
          <ol>
            <li><a href="/">Home</a></li>
            <li class="sep" aria-hidden="true">‚Ä∫</li>
            <li aria-current="page" id="crumbCurrent">Produk</li>
          </ol>
        </nav>
        <h1 class="page-title">Katalog Produk</h1>
      </header>

      <main class="card-content" id="main">
        <!-- Filter -->
        <section class="filters">
          <div class="search-wrap">
            <span class="iconify" data-icon="mdi:magnify"></span>
            <input id="q" type="search" placeholder="Cari produk‚Ä¶ (mis. kursi, meja)" autocomplete="off">
          </div>

          <div class="selects">
            <label class="select">
              <span class="select-label">Kategori</span>
              <select id="catSelect">
                <option value="*">Semua Kategori</option>
              </select>
            </label>

            <label class="select">
              <span class="select-label">Tag</span>
              <select id="tagSelect" multiple></select>
            </label>
          </div>

          <p class="hint">Tip: tahan <b>Ctrl/Cmd</b> untuk pilih banyak tag.</p>
        </section>

        <!-- Grid -->
        <section class="produk-grid" id="grid" aria-live="polite"></section>

        <!-- Empty state -->
        <template id="emptyTpl">
          <div class="empty">
            <div class="empty-emoji">ü§î</div>
            <p>Tidak ada produk yang cocok dengan filter kamu.</p>
          </div>
        </template>
      </main>

      <!-- NAV -->
      <nav class="in-card-nav" aria-label="Navigasi utama">
        <div class="nav-content">
          <a href="/" class="nav-item" title="Home" aria-label="Home">
            <span class="iconify" data-icon="mdi:home-outline"></span>
          </a>

          <button type="button" class="menu-button" id="menuButton" aria-controls="popupMenu" aria-expanded="false" aria-label="Menu">
            <span class="iconify" data-icon="mdi:view-grid-outline"></span>
          </button>

          <a href="/keranjang" class="nav-item js-cart-btn" title="Keranjang" aria-label="Keranjang">
            <span class="iconify" data-icon="mdi:cart-outline"></span>
            <span class="cart-badge" data-cart-count>0</span>
          </a>
        </div>
      </nav>

    </div>
  </div>

  <!-- Popup menu -->
  <div class="popup-menu" id="popupMenu"></div>

  <!-- Cart core -->
  <script src="/assets/cart.js" defer></script>

  <script>
  (function(){
    const grid = document.getElementById('grid');
    const qEl  = document.getElementById('q');
    const cat  = document.getElementById('catSelect');
    const tag  = document.getElementById('tagSelect');
    const crumbCurrent = document.getElementById('crumbCurrent');
    const emptyTpl = document.getElementById('emptyTpl');

    const WA_NUM = '628888085772'; // ganti kalau perlu

    let PRODUCTS = [];
    let ALL_TAGS = new Set();
    let ALL_CATS = new Set();

    const fmtIDR = v => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(v);

    function waLink(p){
      const text = encodeURIComponent(`Halo Customin.co, saya tertarik dengan produk: ${p.title} (${location.origin}/produk/${p.slug}.html)`);
      return `https://wa.me/${WA_NUM}?text=${text}`;
    }

    function cardHTML(p){
      const badge = p.badge ? `<span class="badge ${p.badge==='Promo'?'badge-sale':''}">${p.badge}</span>` : '';
      return `
      <article class="product-card" data-kategori="${p.category}" data-tags="${(p.tags||[]).join(',')}">
        <a class="product-img" href="/produk/${p.slug}.html" aria-label="${p.title}">
          <img src="${p.cover}" alt="${p.title}" loading="lazy" decoding="async">
          ${badge}
        </a>
        <div class="product-content">
          <h2 class="product-title"><a href="/produk/${p.slug}.html">${p.title}</a></h2>
          <div class="product-footer">
            <div class="product-price">${fmtIDR(p.price)}</div>
            <a href="${waLink(p)}" class="order-btn" target="_blank" rel="noopener">Order</a>
          </div>
        </div>
      </article>`;
    }

    function render(list){
      grid.innerHTML = list.map(cardHTML).join('');
      if(!list.length){
        grid.innerHTML = '';
        grid.appendChild(emptyTpl.content.cloneNode(true));
      }
    }

    function syncURL(kategori,tags,keyword){
      const p=new URLSearchParams();
      if(keyword) p.set('q',keyword);
      if(kategori && kategori!=='*') p.set('kategori',kategori);
      if(tags.length) p.set('tag',tags.join(','));
      history.replaceState(null,'', p.toString()?`?${p.toString()}`:location.pathname);
    }

    function apply(){
      const keyword=qEl.value.trim().toLowerCase();
      const kategori=cat.value;
      const tags=[...tag.selectedOptions].map(o=>o.value);

      const tagTrail=tags.length?' ¬∑ '+tags.map(t=>`#${t}`).join(', '):'';
      crumbCurrent.textContent=(kategori==='*'?'Produk':`Produk ‚Ä∫ ${kategori}`)+tagTrail;

      const filtered = PRODUCTS.filter(p=>{
        const matchQ = !keyword || (p.title||'').toLowerCase().includes(keyword);
        const matchK = kategori==='*' || p.category===kategori;
        const matchT = !tags.length || tags.some(t=> (p.tags||[]).includes(t));
        return matchQ && matchK && matchT;
      });
      render(filtered);
      syncURL(kategori,tags,keyword);
    }

    function hydrateFilters(){
      // kategori
      [...ALL_CATS].sort().forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c; opt.textContent=c;
        cat.appendChild(opt);
      });
      // tags (multiple)
      [...ALL_TAGS].sort().forEach(tg=>{
        const opt=document.createElement('option');
        opt.value=tg; opt.textContent=tg;
        tag.appendChild(opt);
      });

      // seed dari URL
      const params=new URLSearchParams(location.search);
      if(params.get('q')) qEl.value=params.get('q');
      if(params.get('kategori') && ALL_CATS.has(params.get('kategori'))) cat.value=params.get('kategori');
      if(params.get('tag')){
        const arr=params.get('tag').split(',').map(decodeURIComponent);
        [...tag.options].forEach(o=>{ if(arr.includes(o.value)) o.selected=true; });
      }
    }

    // ===== Load data =====
    fetch('/data/products.json', {cache:'no-store'})
      .then(r=>{
        if(!r.ok) throw new Error('Gagal load products.json ('+r.status+')');
        return r.json();
      })
      .then(list=>{
        PRODUCTS = Array.isArray(list)? list : [];
        // kumpulkan kategori & tag
        PRODUCTS.forEach(p=>{
          if(p.category) ALL_CATS.add(p.category);
          (p.tags||[]).forEach(t=>ALL_TAGS.add(t));
        });
        hydrateFilters();
        apply();
      })
      .catch(err=>{
        console.error(err);
        grid.innerHTML = `<div class="empty"><div class="empty-emoji">‚ö†Ô∏è</div><p>Tidak bisa memuat data produk.<br><small>Pastikan file <code>/data/products.json</code> ada & valid.</small></p></div>`;
      });

    // events
    qEl.addEventListener('input', apply);
    cat.addEventListener('change', apply);
    tag.addEventListener('change', apply);
  })();

  // ===== Popup menu (seragam) =====
  (function(){
    const btn=document.getElementById('menuButton'), pop=document.getElementById('popupMenu');
    if(!btn||!pop) return;
    pop.innerHTML=`<ul>
      <li><a href="/kategori/"><span class="iconify" data-icon="mdi:shape-outline"></span>Kategori</a></li>
      <li><a href="/tag/"><span class="iconify" data-icon="mdi:tag-outline"></span>Tag</a></li>
      <li><a href="/kontak.html"><span class="iconify" data-icon="mdi:phone-outline"></span>Kontak</a></li>
    </ul>`;
    function close(){ pop.classList.remove('show'); btn.setAttribute('aria-expanded','false'); }
    btn.addEventListener('click',e=>{ e.stopPropagation(); pop.classList.toggle('show'); btn.setAttribute('aria-expanded', pop.classList.contains('show')?'true':'false'); });
    document.addEventListener('click',e=>{ if(!pop.contains(e.target) && !btn.contains(e.target)) close(); });
    document.addEventListener('keydown',e=>{ if(e.key==='Escape') close(); });
  })();
  </script>

  <noscript>
    <style>.produk-grid{display:none}</style>
    Data tidak bisa ditampilkan karena JavaScript nonaktif.
  </noscript>
</body>
</html>
